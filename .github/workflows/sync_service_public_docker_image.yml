name: Publish Electric canary image to Docker Hub

on:
  push:
    # TMP for testing
    # branches: ['main']
    branches: ['alco/ci-build-public-docker-images']

jobs:
  build_and_publish_canary_image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # It is crucial that we checkout the actual HEAD commit of the branch instead of
          # GitHub's ephemeral merge commit that it creates for CI runs by default.
          # We rely on the correct HEAD commit to be checked out in order to determine the
          # correct ELECTRIC_VERSION to bake into the Docker image.
          ref: ${{ github.event.pull_request.head.sha }}
          # Also important to fetch the whole history since otherwise we won't get that tags
          # that are required to determine the correct ELECTRIC_VERSION.
          fetch-depth: 0
          fetch-tags: true

      - name: Determine SHORT_COMMIT_SHA and ELECTRIC_VERSION to use in the build step
        run: |
          echo "SHORT_COMMIT_SHA=$(
            git log -1 --format='%h'
          )" >> $GITHUB_ENV

          echo "ELECTRIC_VERSION=$(
            git describe --abbrev=7 --tags --always --first-parent --match '@core/sync-service@*' | sed -En 's|^@core/sync-service@||p'
          )" >> $GITHUB_ENV

      - uses: docker/setup-buildx-action@v3

      # Login to Docker Hub (create a token in Docker Hub, store as secret).
      #- name: Log in to Docker Hub
      #  uses: docker/login-action@v3
      #  with:
      #    registry: docker.io
      #    username: ${{ secrets.DOCKERHUB_USERNAME }}
      #    password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and publish
        uses: docker/build-push-action@v6
        with:
          context: packages/sync-service
          build-contexts: |
            electric-telemetry=packages/electric-telemetry
          build-args: |
            ELECTRIC_VERSION=${{ env.ELECTRIC_VERSION }}
          platforms: linux/amd64,linux/arm64/v8
          push: true
          tags: |
            electricsql/electric:canary
            electricsql/electric-canary:${{ env.SHORT_COMMIT_SHA }}
            electricsql/electric-canary:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
