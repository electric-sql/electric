[doc Information streaming to Satellite gets filtered out based on the magical `electric_user_id` column]
[global fail_pattern=[Ee][Rr][Rr][Oo][Rr]]
[include _shared.luxinc]

# disable read permissions for this test only. dockerfile is configured to prioritise the 
# features set in the local env, so this flag takes precedence over the default
[invoke setup_with_environment "ELECTRIC_FEATURES=read_permissions=false"]

[invoke electrify_table owned_entries]

[global user_id_1=1]
[global user_id_2=2]

[newshell user_1_ws1]
    -$fail_pattern
    [invoke start_elixir_test 1]
    [invoke client_session $user_id_1 1]
    [invoke elixir_client_subscribe "owned_entries"]

[newshell user_2_ws1]
    [invoke start_elixir_test 2]
    [invoke client_session $user_id_2 1]
    [invoke elixir_client_subscribe "owned_entries"]
    # We expect to NOT see this row
    -($fail_pattern|sentinel value)

[shell pg_1]
    !BEGIN;
    !INSERT INTO owned_entries (id, electric_user_id, content) VALUES ('00000000-0000-0000-0000-000000000000', '1', 'sentinel value');
    !COMMIT;
    ?$psql

[shell electric]
    # migration is sent for both clients
    ?+client_id=client_1_1 .+ user_id=1 \[debug\] trans:(.*)%Electric.Replication.Changes.Migration
    ?client_id=client_2_1 .+ user_id=2 \[debug\] trans:(.*)%Electric.Replication.Changes.Migration
    # the insert is only sent to user_id=1
    ?client_id=client_1_1 .+ user_id=1 \[debug\] trans:(.*)%Electric.Replication.Changes.NewRecord

[shell user_1_ws1]
    # And receive it on Satellite 1. Assertion for the row missing on Satellite 2 is above
    ?rec \[\d+\]: %Electric.Satellite.SatOpLog\{(.*)row_data: %Electric\.Satellite\.SatOpRow\{
    ?values: \["00000000-0000-0000-0000-000000000000", "1", "sentinel value"\]
    ?\}
    ?tags: \["postgres_1@\d{13,16}"\]
    ?\}

[cleanup]
    [invoke teardown]
