[doc Verify that all of the expected stack metrics are exported via Otel]

[include _macros.luxinc]

[global pg_container_name=stack-telemetry__pg]

###

[invoke setup_otel_collector]

[invoke setup_pg]

[invoke setup_electric_with_env "ELECTRIC_OTLP_ENDPOINT=http://localhost:4318 ELECTRIC_SYSTEM_METRICS_POLL_INTERVAL=1s ELECTRIC_OTEL_EXPORT_PERIOD=2s DO_NOT_START_CONN_MAN_PING=1 ELECTRIC_LOG_LEVEL=info OTEL_RESOURCE_ATTRIBUTES=custom.attr=electric.val"]

[shell otel_collector]
  # Verify that the Collector receives metrics from Electric with expected resource attributes
  """?
  info	ResourceMetrics #0
  Resource SchemaURL: 
  Resource attributes:
       -> custom.attr: Str\(electric.val\)
       -> instance.id: Str\([-a-f0-9]+\)
       -> name: Str\(metrics\)
       -> service.name: Str\(electric\)
       -> service.version: Str\([0-9.]+\)
       -> stack_id: Str\(single_stack\)
  """

  # Verify that LSN metrics are exported
  """?
  Metric #[0-9]+
  Descriptor:
       -> Name: electric\.postgres\.replication\.pg_wal_offset
       -> Description: 
       -> Unit: 
       -> DataType: Gauge
  NumberDataPoints #0
  StartTimestamp: [-0-9]+ [.:0-9]+ [-+0-9]+ UTC
  Timestamp: [-0-9]+ [.:0-9]+ [-+0-9]+ UTC
  Value: [-+.0-9]+
  """

  """?
  Metric #[0-9]+
  Descriptor:
       -> Name: electric\.postgres\.replication\.slot_confirmed_flush_lsn_lag
       -> Description: 
       -> Unit: By
       -> DataType: Gauge
  NumberDataPoints #0
  StartTimestamp: [-0-9]+ [.:0-9]+ [-+0-9]+ UTC
  Timestamp: [-0-9]+ [.:0-9]+ [-+0-9]+ UTC
  Value: [-+.0-9]+
  """

  """?
  Metric #[0-9]+
  Descriptor:
       -> Name: electric\.postgres\.replication\.slot_retained_wal_size
       -> Description: 
       -> Unit: By
       -> DataType: Gauge
  NumberDataPoints #0
  StartTimestamp: [-0-9]+ [.:0-9]+ [-+0-9]+ UTC
  Timestamp: [-0-9]+ [.:0-9]+ [-+0-9]+ UTC
  Value: [-+.0-9]+
  """

###

[cleanup]
  [invoke teardown]
