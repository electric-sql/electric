[doc Verify that Electric can gracefully handle the replication slot conflict that appears after the attempt to start streaming]

[include _macros.luxinc]

[global pg_container_name=replication-slot-self-conflict__pg]

[my invalidated_slot_error=
  """
  ** (Postgrex.Error) ERROR 55000 (object_not_in_prerequisite_state) cannot read from logical replication slot "electric_slot_integration"

  This slot has been invalidated because it exceeded the maximum reserved size.
  """]

## Start a new Postgres cluster
[invoke setup_pg]

## Start a pending transaction that will block Electric's initialization
[invoke start_psql]
[shell psql]
  !BEGIN;
  ??BEGIN

  !SELECT pg_current_xact_id();
  ??pg_current_xact_id
  ??(1 row)

## Start the sync service.
[invoke setup_electric]

[shell electric]
  # Slightly larger timeout than the default because we're going to match against warnings that
  # are logged after 10 seconds of idling.
  [timeout 12]
  # Set the failure match pattern such that we can prove that replication does not start since
  # it's blocked by the pending transaction.
  -Starting replication from postgres|$fail_pattern

  ??[debug] Starting replication client for stack single_stack
  ??[info] Acquiring lock from postgres with name electric_slot_integration
  ??[info] Lock acquired from postgres with name electric_slot_integration
  ??[debug] ReplicationClient step: create_slot
  ??[warning] Waiting for the replication connection setup to complete...

# Terminate Electric. Even though it closes all database connections, there still remains a
# live backend in Postgres blocked on the `CREATE_REPLICATION_SLOT` statement, which also holds
# the advisory lock. However, the slot has already been created and can be seen in the result
# of `SELECT * FROM pg_replication_slots` and shown as active. So restarting Electric puts
# it into an odd state where it cannot acquire the lock.
[shell electric]
  !:ok = Application.stop(:electric)
  !:ok = Application.start(:electric)

  -Lock acquired from postgres|$fail_pattern

  ??[info] Acquiring lock from postgres with name electric_slot_integration

# Rollback the pending transaction to unblock Electric and verify that it completes its initialization.
[shell psql]
  !ROLLBACK;

[shell electric]
  -$fail_pattern

  ??[info] Lock acquired from postgres with name electric_slot_integration
  ??[debug] ReplicationClient step: create_slot
  ??[debug] Created new slot at lsn=

  ??[info] Starting replication from postgres
  ??[debug] ReplicationClient step: start_streaming
  ??[debug] ReplicationClient step: start_replication_slot
  ??[debug] Primary Keepalive

[cleanup]
  [invoke teardown]
