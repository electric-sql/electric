[doc Verify that Electric doesn't work correctly without ownership of the user table]

[include _macros.luxinc]

[global pg_container_name=not-owner-of-the-table__pg]
[global database_url=postgresql://low_privilege:password@localhost:$pg_host_port/electric?sslmode=disable]

###

## Start a Postgres cluster with a role that does not own the user table
[invoke setup_pg_with_shell_name \
  "pg" \
  "-e INIT_DB_SQL=\"\
    CREATE ROLE low_privilege LOGIN PASSWORD 'password' REPLICATION;\
    GRANT CREATE ON DATABASE electric TO low_privilege\"" \
  "" \
  "-v $(realpath ../scripts/init_db.sh):/docker-entrypoint-initdb.d/initdb-init_db.sh"]

## Start the sync service
[invoke setup_electric_with_env "ELECTRIC_TWEAKS_PUBLICATION_REFRESH_PERIOD=2s"]

## Verify that the replication pipeline has initialized successfully
[shell electric]
  ??Starting shape replication pipeline
  ??Starting replication from postgres

## Create a table and verify that Electric reports an error because it cannot add it to the publication
[invoke start_psql]

[shell psql]
  !CREATE TABLE items(val text);
  !INSERT INTO items VALUES ('hello');
  ??INSERT 0 1

[shell client]
  -

  # Electric fails to add the table to the publication
  [invoke shape_get_snapshot items]
  ??HTTP/1.1 503
  ??{"message":"Unable to create initial snapshot: must be owner of table items"}

[shell electric]
  -

  ??[info] Configuring publication electric_publication_integration to drop [] tables, and add ["public.items"] tables
  ?\[error\] Failed to configure publication: %Postgrex.Error\{message: nil, postgres: %\{code: :insufficient_privilege,.*message: "must be owner of table items"

## Add the table to the publication and try again
[shell psql]
  !ALTER PUBLICATION electric_publication_integration ADD TABLE items;
  ??ALTER PUBLICATION
  ??ALTER PUBLICATION

  !SELECT * FROM pg_publication_tables;
  ??electric_publication_integration | public     | items
  ??(1 row)

[shell client]
  # Electric still fails because it's trying to alter items' replica identity
  # (it doesn't check whether it's already there)
  [invoke shape_get_snapshot items]
  ??HTTP/1.1 503
  ??{"message":"Unable to create initial snapshot: must be owner of table items"}

[shell electric]
	??[info] Altering identity of public.items to FULL
  ?\[error\] Failed to configure publication: %Postgrex.Error\{message: nil, postgres: %\{code: :insufficient_privilege,.*message: "must be owner of table items"

## Wait for the publication to be refreshed and verify that the table is removed from it
[shell electric]
  ??[info] Configuring publication electric_publication_integration to drop ["public.items"] tables, and add [] tables

  # sleep a bit to ensure the publication update completed
  [sleep 3]

[shell psql]
  !SELECT * FROM pg_publication_tables;
  ??(0 rows)

[cleanup]
  [invoke teardown]
