[doc Verify that Electric can work without ownership of the user table when configured with manual table publishing]

[include _macros.luxinc]

[global pg_container_name=manual-table-publishing__pg]
[global database_url=postgresql://low_privilege:password@localhost:$pg_host_port/electric?sslmode=disable]

###

## Start a Postgres cluster with a role that does not own the user table
[invoke setup_pg_with_shell_name \
  "pg" \
  "-e INIT_DB_SQL=\"\
    CREATE ROLE low_privilege LOGIN PASSWORD 'password' REPLICATION;\
    GRANT CREATE ON DATABASE electric TO low_privilege\"" \
  "" \
  "-v $(realpath ../scripts/init_db.sh):/docker-entrypoint-initdb.d/initdb-init_db.sh"]

## Start the sync service
[invoke setup_electric_with_env "ELECTRIC_MANUAL_TABLE_PUBLISHING=true"]

## Verify that the replication pipeline has initialized successfully
[shell electric]
  ??Starting shape replication pipeline
  ??Starting replication from postgres

## Create a table and verify that Electric reports an error because it cannot add it to the publication
[invoke start_psql]

[shell psql]
  !CREATE TABLE items(val text);
  !INSERT INTO items VALUES ('hello');
  ??INSERT 0 1

[shell client]
  -

  # Electric fails to add the table to the publication
  [invoke shape_get_snapshot items]
  ??HTTP/1.1 503
  ??{"message":"Database table \"public.items\" is missing from the publication \"electric_publication_integration\" and the ELECTRIC_MANUAL_TABLE_PUBLISHING setting prevents Electric from adding it"}

[shell electric]
  -
  ?\[warning\] Failed to create snapshot for \d+-\d+: Database table \"public.items\" is missing from the publication \"electric_publication_integration\" and the ELECTRIC_MANUAL_TABLE_PUBLISHING setting prevents Electric from adding it
  -$fail_pattern

## Add the table to the publication and try again
[shell psql]
  !ALTER PUBLICATION electric_publication_integration ADD TABLE items;
  ??ALTER PUBLICATION
  ??ALTER PUBLICATION

  !SELECT * FROM pg_publication_tables;
  ??electric_publication_integration | public     | items
  ??(1 row)

[shell client]
  # Electric still fails because the table's replica identity requirement isn't met
  [invoke shape_get_snapshot items]
  ??HTTP/1.1 503
  ??{"message":"Database table \"public.items\" does not have its replica identity set to FULL"}

[shell electric]
  -
  ?\[warning\] Failed to create snapshot for \d+-\d+: Database table \"public.items\" does not have its replica identity set to FULL
  -$fail_pattern

## Set table's replica identity to FULL and try again
[shell psql]
  !ALTER TABLE items REPLICA IDENTITY FULL;
  ??ALTER TABLE
  ??ALTER TABLE

[shell client]
  [invoke shape_get_snapshot items]
  ??HTTP/1.1 503
  ??{"message":"Unable to create initial snapshot: permission denied for table items"}

## Grant Electric read access to the table and try again
[shell psql]
  !GRANT SELECT ON items TO low_privilege;
  ??GRANT
  ??GRANT

[shell client]
  [invoke shape_get_snapshot items]
  ??HTTP/1.1 200
  ??transfer-encoding: chunked
  ??electric-schema: {"val":{"type":"text"}}
  ??electric-offset: 0_0

  ??[{"key":"\"public\".\"items\"/\"hello\"","value":{"val":"hello"},"headers":{"relation":["public","items"],"operation":"insert"}},{"headers":{"control":"snapshot-end"

## Wait for the schema reconciler to run and verify that the table is NOT removed from the publication
[shell psql]
  !ALTER TABLE items REPLICA IDENTITY FULL;
  ??ALTER TABLE
  ??ALTER TABLE

[shell electric]
  ??[info] Verified publication electric_publication_integration to include ["public.items"] tables with REPLICA IDENTITY FULL

[shell psql]
  !SELECT * FROM pg_publication_tables;
  ??electric_publication_integration | public     | items
  ??(1 row)

[cleanup]
  [invoke teardown]
